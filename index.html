import React, { useState, useEffect, useCallback, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, getDoc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, getDocs } from 'firebase/firestore';

const Modal = ({ isOpen, onClose, title, children }) => {
    const modalRef = useRef();
    useEffect(() => {
        const handleClickOutside = (event) => {
            if (modalRef.current && !modalRef.current.contains(event.target)) {
                onClose();
            }
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, [onClose]);
    if (!isOpen) return null;
    return (
        <div className="modal-bg fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900 bg-opacity-30 backdrop-blur-md">
            <div ref={modalRef} className="modal-card bg-white rounded-2xl shadow-2xl p-4 sm:p-6 w-full max-w-xl max-h-[90vh] overflow-hidden flex flex-col">
                <div className="flex-shrink-0 flex justify-between items-center p-4 -mx-4 -mt-4 sm:p-6 sm:-mx-6 sm:-mt-6 mb-4 border-b border-slate-200">
                    <h3 className="text-xl font-semibold">{title}</h3>
                    <button className="p-1 rounded-full text-slate-500 hover:bg-slate-100 transition-colors" onClick={onClose}>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" className="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>
                </div>
                <div className="flex-grow overflow-y-auto hide-scrollbar p-6">
                    {children}
                </div>
            </div>
        </div>
    );
};

const PartySection = ({ title, defaultOpen, children }) => {
    const [isOpen, setIsOpen] = useState(defaultOpen);
    return (
        <div className="bg-white rounded-xl shadow-md p-4 space-y-4">
            <div className="flex justify-between items-center cursor-pointer" onClick={() => setIsOpen(!isOpen)}>
                <h4 className="text-lg font-semibold text-slate-700">{title}</h4>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" className={`lucide lucide-chevron-down text-slate-500 transition-transform ${isOpen ? 'rotate-180' : ''}`}><path d="m6 9 6 6 6-6"/></svg>
            </div>
            <div className={`${isOpen ? '' : 'hidden'}`}>
                {children}
            </div>
        </div>
    );
};

const CalendarView = ({ calRef, setCalRef, parties, onOpenParty }) => {
    const startOfMonth = d => new Date(d.getFullYear(), d.getMonth(), 1);
    const endOfMonth = d => new Date(d.getFullYear(), d.getMonth() + 1, 0);
    const todayISO = () => new Date().toISOString().slice(0, 10);
    const daysUntil = iso => {
        const d = parseISO(iso);
        if (!d) return null;
        const today = new Date();
        const base = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const tgt = new Date(d.getFullYear(), d.getMonth(), d.getDate());
        return Math.round((tgt - base) / 86400000);
    };
    const parseISO = s => s ? new Date(s + 'T12:00:00') : null;
    const hashHue = str => { let h = 0; for (let i = 0; i < str.length; i++) { h = (h * 31 + str.charCodeAt(i)) >>> 0; } return h % 360; };
    const colorForContact = idOrName => { const key = idOrName || ''; const hue = hashHue(key); return `hsl(${hue} 70% 45%)`; };

    const monthStart = startOfMonth(calRef);
    const monthEnd = endOfMonth(calRef);
    const startDow = (monthStart.getDay() + 7) % 7;
    const totalDays = monthEnd.getDate();
    
    const days = [];
    for (let i = 0; i < startDow; i++) days.push(<div key={`pad-${i}`}></div>);

    for (let day = 1; day <= totalDays; day++) {
        const d = new Date(calRef.getFullYear(), calRef.getMonth(), day);
        const iso = d.toISOString().slice(0, 10);
        const partiesOnDay = parties.filter(p => p.date === iso);
        days.push(
            <div key={iso} className={`rounded-md p-2 bg-slate-50 border border-slate-200 text-slate-800 text-left cursor-pointer hover:bg-slate-100 transition-colors shadow-sm ${iso === todayISO() ? 'ring-2 ring-blue-500' : ''}`}>
                <div className="text-xs font-semibold mb-1">{day}</div>
                {partiesOnDay.map(p => (
                    <div key={p.docId} className="flex items-center gap-1 text-[10px] truncate text-slate-600" onClick={() => onOpenParty(p.docId)}>
                        <span className="w-2 h-2 rounded-full inline-block" style={{ background: colorForContact(p.forContactId || p.title) }}></span>
                        {p.title}
                    </div>
                ))}
            </div>
        );
    }

    return (
        <div className="lg:col-span-2">
            <div className="bg-white rounded-xl shadow-lg p-6">
                <div className="flex justify-between items-center mb-4">
                    <button className="flex items-center justify-center gap-2 px-3 py-1 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200" onClick={() => setCalRef(new Date(calRef.getFullYear(), calRef.getMonth() - 1, 1))}>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" className="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>
                    </button>
                    <div className="text-xl font-semibold">{monthStart.toLocaleString(undefined, { month: 'long', year: 'numeric' })}</div>
                    <button className="flex items-center justify-center gap-2 px-3 py-1 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200" onClick={() => setCalRef(new Date(calRef.getFullYear(), calRef.getMonth() + 1, 1))}>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" className="lucide lucide-chevron-right"><path d="m9 18 6-6-6-6"/></svg>
                    </button>
                </div>
                <div className="grid grid-cols-7 gap-2 text-center text-sm">
                    <div className="font-bold text-slate-500">Sun</div><div className="font-bold text-slate-500">Mon</div><div className="font-bold text-slate-500">Tue</div><div className="font-bold text-slate-500">Wed</div><div className="font-bold text-slate-500">Thu</div><div className="font-bold text-slate-500">Fri</div><div className="font-bold text-slate-500">Sat</div>
                    {days}
                </div>
            </div>
        </div>
    );
};

const HostDetails = ({ party, contacts, invitees, items, rentals, vendors, messages, partySummary, onUpdateInvitees, onUpdateItems, onUpdateRentals, onUpdateVendors, onUpdateMessages, showMessage, myContactId }) => {
    const [newItemName, setNewItemName] = useState('');
    const [newItemQty, setNewItemQty] = useState(1);
    const [newItemCost, setNewItemCost] = useState(0);
    const [newItemAssignedTo, setNewItemAssignedTo] = useState('');
    const [newItemVendor, setNewItemVendor] = useState('');
    const [itemFilter, setItemFilter] = useState('all');

    const statusBadge = s => {
        const colors = { 'picked': 'bg-green-100 text-green-600', 'ordered': 'bg-blue-100 text-blue-600', 'todo': 'bg-slate-100 text-slate-600', 'rented': 'bg-orange-100 text-orange-600', 'borrowed': 'bg-purple-100 text-purple-600', 'returned': 'bg-green-100 text-green-600' };
        return <span className={`inline-flex items-center gap-1 text-xs font-medium rounded-full px-2 py-0.5 ${colors[s]}`}>{s.toUpperCase()}</span>;
    };
    
    const loadWeather = async (location, date) => {
        const weatherContent = document.getElementById('weatherContent');
        if (!weatherContent) return;
        weatherContent.innerHTML = `<p>Loading weather data...</p>`;
        if (!location) { weatherContent.innerHTML = `<p className="text-red-500">Please add a location to the party to get a forecast.</p>`; return; }
        const apiKey = 'YOUR_OPENWEATHERMAP_API_KEY';
        if (apiKey === 'YOUR_OPENWEATHERMAP_API_KEY') { weatherContent.innerHTML = `<p className="text-red-500">Weather API key is not configured.</p>`; return; }
        try {
            const geocodeUrl = `https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(location)}&limit=1&appid=${apiKey}`;
            const geocodeRes = await fetch(geocodeUrl);
            const geocodeData = await geocodeRes.json();
            if (geocodeData.length === 0) throw new Error('Location not found.');
            const { lat, lon } = geocodeData[0];
            const weatherUrl = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=imperial&appid=${apiKey}`;
            const weatherRes = await fetch(weatherUrl);
            const weatherData = await weatherRes.json();
            const forecast = weatherData.list?.find(item => item.dt_txt.startsWith(date));
            if (forecast) {
                weatherContent.innerHTML = `<div className="space-y-2 mt-2"><p>Forecast for ${date}:</p><p>Temp: ${forecast.main.temp}Â°F</p><p>Condition: ${forecast.weather[0].description}</p></div>`;
            } else {
                weatherContent.innerHTML = `<p>No forecast available for that date.</p>`;
            }
        } catch (e) { console.error('Weather fetch error:', e); weatherContent.innerHTML = `<p className="text-red-500">Failed to fetch weather data: ${e.message}</p>`; }
    };

    const handleAddInvitee = async (e) => {
        e.preventDefault();
        const selectElement = document.getElementById('invContact');
        const contactId = selectElement.value;
        if (!contactId) {
            showMessage("Please select a contact.", "error");
            return;
        }
        const newInviteeObj = {
            docId: `inv-${Date.now()}`,
            contactId,
            status: 'invited',
            gift: '',
            thankYou: false
        };
        onUpdateInvitees([...invitees, newInviteeObj]);
        selectElement.value = '';
        showMessage('Invitee added!', 'success');
    };

    const removeInvitee = (inviteeId) => {
        onUpdateInvitees(invitees.filter(i => i.docId !== inviteeId));
        showMessage('Invitee removed!', 'success');
    };

    const addItem = async (e) => {
        e.preventDefault();
        const newItemObj = {
            docId: `item-${Date.now()}`,
            name: newItemName.trim(),
            qty: newItemQty,
            cost: newItemCost,
            assignedTo: newItemAssignedTo,
            vendorId: newItemVendor,
            status: 'todo'
        };
        if (!newItemObj.name) {
            showMessage('Item name required.', 'error');
            return;
        }
        onUpdateItems([...items, newItemObj]);
        setNewItemName('');
        setNewItemQty(1);
        setNewItemCost(0);
        setNewItemAssignedTo('');
        setNewItemVendor('');
        showMessage('Item added!', 'success');
    };

    const removeItem = (itemId) => {
        onUpdateItems(items.filter(i => i.docId !== itemId));
        showMessage('Item removed!', 'success');
    };

    const addRental = async (e) => {
        e.preventDefault();
        const form = e.target;
        const newRentalObj = {
            docId: `rental-${Date.now()}`,
            name: form.rentName.value.trim(),
            qty: parseInt(form.rentQty.value) || 1,
            cost: parseFloat(form.rentCost.value) || 0,
            status: form.rentStatus.value
        };
        if (!newRentalObj.name) {
            showMessage('Rental item name required.', 'error');
            return;
        }
        onUpdateRentals([...rentals, newRentalObj]);
        form.reset();
        showMessage('Rental added!', 'success');
    };

    const removeRental = (rentalId) => {
        onUpdateRentals(rentals.filter(r => r.docId !== rentalId));
        showMessage('Rental removed!', 'success');
    };

    const addVendor = async (e) => {
        e.preventDefault();
        const form = e.target;
        const newVendorObj = {
            docId: `vendor-${Date.now()}`,
            name: form.vName.value.trim(),
            type: form.vType.value.trim(),
            phone: form.vPhone.value.trim(),
            email: form.vEmail.value.trim(),
            site: form.vSite.value.trim(),
            notes: form.vNotes.value.trim()
        };
        if (!newVendorObj.name) {
            showMessage('Vendor name required.', 'error');
            return;
        }
        onUpdateVendors([...vendors, newVendorObj]);
        form.reset();
        showMessage('Vendor added!', 'success');
    };

    const removeVendor = (vendorId) => {
        onUpdateVendors(vendors.filter(v => v.docId !== vendorId));
        showMessage('Vendor removed!', 'success');
    };

    const postMessage = async (e) => {
        e.preventDefault();
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if (!text) return;
        
        const myContact = contacts.find(c => c.docId === myContactId);
        const newMessageObj = {
            docId: `msg-${Date.now()}`,
            message: text,
            authorId: myContactId,
            timestamp: Date.now()
        };
        onUpdateMessages([...messages, newMessageObj]);
        input.value = '';
        showMessage('Message posted!', 'success');
    };

    const filteredItems = itemFilter === 'all' ? items : items.filter(item => item.vendorId === itemFilter);
    
    return (
        <div className="space-y-6">
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
                <div className="bg-slate-100 rounded-lg p-3 text-center text-sm font-medium text-slate-600 shadow-sm">Estimated Cost<div className="text-lg font-bold">{fmtMoney(partySummary.totalCost)}</div></div>
                <div className="bg-slate-100 rounded-lg p-3 text-center text-sm font-medium text-slate-600 shadow-sm">Items To Buy<div className="text-lg font-bold">{partySummary.itemsToBuy}</div></div>
                <div className="bg-slate-100 rounded-lg p-3 text-center text-sm font-medium text-slate-600 shadow-sm">Guests Confirmed<div className="text-lg font-bold">{partySummary.confirmedGuests}</div></div>
                <div className="bg-slate-100 rounded-lg p-3 text-center text-sm font-medium text-slate-600 shadow-sm">Adults<div className="text-lg font-bold">{partySummary.adults}</div></div>
                <div className="bg-slate-100 rounded-lg p-3 text-center text-sm font-medium text-slate-600 shadow-sm">Kids<div className="text-lg font-bold">{partySummary.kids}</div></div>
            </div>

            <div className="bg-white rounded-xl shadow-md p-4 space-y-4">
                <h4 className="text-lg font-semibold text-slate-700">Edit Party Details</h4>
                <div className="space-y-2">
                    <div><label className="block text-sm font-medium text-slate-600 mb-1">Party Name</label><input onChange={e => {
                        const updatedParties = myParties.map(p => p.docId === party.docId ? { ...p, title: e.target.value } : p);
                        setMyParties(updatedParties);
                    }} value={party.title || ''} className="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                    <div><label className="block text-sm font-medium text-slate-600 mb-1">Date</label><input type="date" onChange={e => {
                        const updatedParties = myParties.map(p => p.docId === party.docId ? { ...p, date: e.target.value } : p);
                        setMyParties(updatedParties);
                    }} value={party.date || ''} className="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                    <div><label className="block text-sm font-medium text-slate-600 mb-1">Time</label><input type="time" onChange={e => {
                        const updatedParties = myParties.map(p => p.docId === party.docId ? { ...p, time: e.target.value } : p);
                        setMyParties(updatedParties);
                    }} value={party.time || ''} className="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                    <div><label className="block text-sm font-medium text-slate-600 mb-1">Location</label><input onChange={e => {
                        const updatedParties = myParties.map(p => p.docId === party.docId ? { ...p, location: e.target.value } : p);
                        setMyParties(updatedParties);
                    }} value={party.location || ''} className="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                </div>
            </div>

            <div className="bg-white rounded-xl shadow-md p-4">
                <div className="flex justify-between items-center cursor-pointer" onClick={(e) => e.currentTarget.nextSibling.classList.toggle('hidden')}>
                    <h4 className="text-lg font-semibold text-slate-700">Local Weather Forecast</h4>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" className="lucide lucide-chevron-down text-slate-500"><path d="m6 9 6 6 6-6"/></svg>
                </div>
                <div id="weatherContent" className="mt-2 text-sm text-slate-600">
                    <p>Click below to load the weather forecast.</p>
                    <button className="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-white bg-slate-800 hover:bg-slate-900 transition-colors shadow-md mt-2" onClick={() => loadWeather(party.location, party.date)}>Load Weather</button>
                </div>
            </div>

            <PartySection title="Guests & Invitees" defaultOpen>
                <div className="flex flex-wrap gap-2 text-sm">
                    <div className="text-slate-500">Expected Guests:</div>
                    <input type="number" min="0" value={party.guestCount || 0} onChange={e => {
                        const updatedParties = myParties.map(p => p.docId === party.docId ? { ...p, guestCount: parseInt(e.target.value) || 0 } : p);
                        setMyParties(updatedParties);
                    }} className="w-24 h-8 text-center px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/>
                </div>
                <form className="flex flex-wrap items-end gap-2 mt-4" onSubmit={handleAddInvitee}>
                    <div className="flex-1 min-w-[150px]">
                        <label className="block text-sm font-medium text-slate-600 mb-1">Pick a contact</label>
                        <select id="invContact" className="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                            <option value="">â Select â</option>
                            {contacts.filter(c => c.userId !== myContactId && !invitees.find(i => i.contactId === c.docId)).map(c => <option key={c.docId} value={c.docId}>{c.name}</option>)}
                        </select>
                    </div>
                    <button type="submit" className="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-white bg-slate-800 hover:bg-slate-900 transition-colors shadow-md">Add</button>
                    <button type="button" className="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm" onClick={() => setIsContactFormModalOpen(true)}>New Contact</button>
                </form>
                <div className="overflow-x-auto hide-scrollbar mt-4">
                    <table className="w-full table-auto text-sm">
                        <thead>
                            <tr className="text-left text-slate-500 font-medium"><th className="p-2">Name</th><th className="p-2">Age</th><th className="p-2">Status</th><th className="p-2">Gift</th><th className="p-2">Thank You</th><th className="p-2 text-right">Actions</th></tr>
                        </thead>
                        <tbody>
                            {invitees?.map(i => {
                                const contact = contacts.find(c => c.docId === i.contactId);
                                const age = contact?.birthday ? (new Date(party.date).getFullYear() - new Date(contact.birthday).getFullYear()) : 'â';
                                return (
                                    <tr key={i.docId} className="hover:bg-slate-50 transition-colors">
                                        <td className="p-2">{contact?.name || '(Unknown)'}</td>
                                        <td className="p-2">{age}</td>
                                        <td className="p-2">
                                            <div className="flex items-center gap-1">
                                                {['invited', 'rsvp', 'declined'].map(status => (
                                                    <button key={status} onClick={() => {
                                                        const updatedInvitees = invitees.map(inv => inv.docId === i.docId ? { ...inv, status } : inv);
                                                        onUpdateInvitees(updatedInvitees);
                                                    }} className={`text-xs px-2 py-1 rounded-full ${i.status === status ? 'bg-slate-800 text-white' : 'bg-slate-200 text-slate-600'}`}>{status.charAt(0).toUpperCase() + status.slice(1)}</button>
                                                ))}
                                            </div>
                                        </td>
                                        <td className="p-2"><input type="text" value={i.gift || ''} onChange={e => {
                                            const updatedInvitees = invitees.map(inv => inv.docId === i.docId ? { ...inv, gift: e.target.value } : inv);
                                            onUpdateInvitees(updatedInvitees);
                                        }} placeholder="Giftâ¦" className="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 text-xs h-8"/></td>
                                        <td className="p-2 text-center"><input type="checkbox" checked={i.thankYou} onChange={e => {
                                            const updatedInvitees = invitees.map(inv => inv.docId === i.docId ? { ...inv, thankYou: e.target.checked } : inv);
                                            onUpdateInvitees(updatedInvitees);
                                        }} className="w-4 h-4 rounded text-blue-600 focus:ring-blue-500 border-slate-300"/></td>
                                        <td className="p-2 text-right"><button onClick={() => removeInvitee(i.docId)} className="flex items-center justify-center px-2 py-1 rounded-lg font-semibold text-white bg-red-500 hover:bg-red-600 text-xs">Remove</button></td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            </PartySection>
            
            <PartySection title="Shopping List & Assignments" defaultOpen>
                <form className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-end" onSubmit={addItem}>
                    <div><label className="block text-sm font-medium text-slate-600 mb-1">Item</label><input name="itName" placeholder="Cake, platesâ¦" className="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                    <div><label className="block text-sm font-medium text-slate-600 mb-1">Qty</label><input name="itQty" type="number" min="1" defaultValue="1" className="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                    <div><label className="block text-sm font-medium text-slate-600 mb-1">Cost (each)</label><input name="itCost" type="number" min="0" step="0.01" defaultValue="0" className="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                    <div><label className="block text-sm font-medium text-slate-600 mb-1">Assign to</label>
                      <select name="itAssign" className="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                        <option value="">â Unassigned â</option>
                        {contacts.map(c => <option key={c.docId} value={c.docId}>{c.name}</option>)}
                      </select>
                    </div>
                    <div><label className="block text-sm font-medium text-slate-600 mb-1">Status</label><select name="itStatus" className="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"><option value="todo">To buy</option><option value="ordered">Ordered</option><option value="picked">Picked up</option></select></div>
                    <div className="flex gap-2">
                        <button type="submit" className="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-white bg-slate-800 hover:bg-slate-900 transition-colors shadow-md flex-1">Add Item</button>
                    </div>
                </form>
                <div className="overflow-x-auto hide-scrollbar mt-4">
                    <table className="w-full table-auto text-sm">
                        <thead>
                            <tr className="text-left text-slate-500 font-medium"><th className="p-2">Item</th><th className="p-2">Assigned</th><th className="p-2">Qty</th><th className="p-2">Cost</th><th className="p-2">Status</th><th className="p-2 text-right">Actions</th></tr>
                        </thead>
                        <tbody>
                            {items?.map(item => (
                                <tr key={item.docId} className="hover:bg-slate-50 transition-colors">
                                    <td className="p-2">{item.name}</td>
                                    <td className="p-2 text-slate-500">{contacts.find(c => c.docId === item.assignedTo)?.name || 'â'}</td>
                                    <td className="p-2">{item.qty || 1}</td>
                                    <td className="p-2">{fmtMoney((item.cost || 0) * (item.qty || 1))}</td>
                                    <td className="p-2">
                                        <div className="flex items-center">
                                            <span className={`px-2 py-1 text-xs rounded-full ${item.status === 'picked' ? 'bg-green-100 text-green-600' : item.status === 'ordered' ? 'bg-blue-100 text-blue-600' : 'bg-slate-100 text-slate-600'}`}>
                                                {item.status}
                                            </span>
                                        </div>
                                    </td>
                                    <td className="p-2 text-right flex gap-1 justify-end">
                                        <button onClick={() => {
                                            const newStatus = item.status === 'todo' ? 'ordered' : item.status === 'ordered' ? 'picked' : 'todo';
                                            onUpdateItems(items.map(it => it.docId === item.docId ? { ...it, status: newStatus } : it));
                                        }} className="flex items-center justify-center px-2 py-1 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 text-xs">Next</button>
                                        <button onClick={() => removeItem(item.docId)} className="flex items-center justify-center px-2 py-1 rounded-lg font-semibold text-white bg-red-500 hover:bg-red-600 text-xs">Remove</button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </PartySection>

            <PartySection title="Rented & Borrowed Items" defaultOpen>
                <form className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-end" onSubmit={addRental}>
                    <div><label className="block text-sm font-medium text-slate-600 mb-1">Item</label><input name="rentName" placeholder="Folding Chairs" className="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                    <div><label className="block text-sm font-medium text-slate-600 mb-1">Qty</label><input name="rentQty" type="number" min="1" defaultValue="1" className="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                    <div><label className="block text-sm font-medium text-slate-600 mb-1">Cost (each)</label><input name="rentCost" type="number" min="0" step="0.01" defaultValue="0" className="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                    <div><label className="block text-sm font-medium text-slate-600 mb-1">Status</label><select name="rentStatus" className="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"><option value="rented">Rented</option><option value="borrowed">Borrowed</option><option value="returned">Returned</option></select></div>
                    <div className="flex gap-2">
                        <button type="submit" className="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-white bg-slate-800 hover:bg-slate-900 transition-colors shadow-md flex-1">Add Item</button>
                    </div>
                </form>
                <div className="overflow-x-auto hide-scrollbar mt-4">
                    <table className="w-full table-auto text-sm">
                        <thead>
                            <tr className="text-left text-slate-500 font-medium"><th className="p-2">Item</th><th className="p-2">Qty</th><th className="p-2">Cost</th><th className="p-2">Status</th><th className="p-2 text-right">Actions</th></tr>
                        </thead>
                        <tbody>
                            {rentals?.map(item => (
                                <tr key={item.docId} className="hover:bg-slate-50 transition-colors">
                                    <td className="p-2">{item.name}</td>
                                    <td className="p-2">{item.qty || 1}</td>
                                    <td className="p-2">{fmtMoney((item.cost || 0) * (item.qty || 1))}</td>
                                    <td className="p-2">
                                        <div className="flex items-center">
                                            <span className={`px-2 py-1 text-xs rounded-full ${item.status === 'rented' ? 'bg-orange-100 text-orange-600' : item.status === 'borrowed' ? 'bg-purple-100 text-purple-600' : 'bg-green-100 text-green-600'}`}>
                                                {item.status}
                                            </span>
                                        </div>
                                    </td>
                                    <td className="p-2 text-right flex gap-1 justify-end">
                                        <button onClick={() => {
                                            const newStatus = item.status === 'rented' ? 'returned' : item.status === 'borrowed' ? 'returned' : 'rented';
                                            onUpdateRentals(rentals.map(it => it.docId === item.docId ? { ...it, status: newStatus } : it));
                                        }} className="flex items-center justify-center px-2 py-1 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 text-xs">Next</button>
                                        <button onClick={() => removeRental(item.docId)} className="flex items-center justify-center px-2 py-1 rounded-lg font-semibold text-white bg-red-500 hover:bg-red-600 text-xs">Remove</button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </PartySection>

            <PartySection title="Vendors" defaultOpen>
                <form className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-end" onSubmit={addVendor}>
                    <div><label className="block text-sm font-medium text-slate-600 mb-1">Name</label><input name="vName" placeholder="Sweet Tooth Cakes" className="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                    <div><label className="block text-sm font-medium text-slate-600 mb-1">Type</label><input name="vType" placeholder="Bakery / Venue / DJ" className="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                    <div><label className="block text-sm font-medium text-slate-600 mb-1">Phone</label><input name="vPhone" placeholder="555-987-6543" className="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                    <div><label className="block text-sm font-medium text-slate-600 mb-1">Email</label><input name="vEmail" type="email" placeholder="hello@vendor.com" className="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                    <div><label className="block text-sm font-medium text-slate-600 mb-1">Website</label><input name="vSite" placeholder="https://â¦" className="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                    <div><label className="block text-sm font-medium text-slate-600 mb-1">Notes</label><input name="vNotes" placeholder="Pickup at 3pm" className="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                    <div className="flex gap-2">
                        <button type="submit" className="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-white bg-slate-800 hover:bg-slate-900 transition-colors shadow-md flex-1">Add Vendor</button>
                    </div>
                </form>
                <div className="overflow-x-auto hide-scrollbar mt-4">
                    <table className="w-full table-auto text-sm">
                        <thead>
                            <tr className="text-left text-slate-500 font-medium"><th className="p-2">Vendor</th><th className="p-2">Type</th><th className="p-2">Contact</th><th className="p-2">Notes</th><th className="p-2 text-right">Actions</th></tr>
                        </thead>
                        <tbody>
                            {vendors?.map(item => (
                                <tr key={item.docId} className="hover:bg-slate-50 transition-colors">
                                    <td className="p-2">{item.name}</td>
                                    <td className="p-2 text-slate-500">{item.type || 'â'}</td>
                                    <td className="p-2 text-slate-500 text-xs">{item.phone || 'â'}</td>
                                    <td className="p-2 text-slate-500 text-xs">{item.notes || 'â'}</td>
                                    <td className="p-2 text-right"><button onClick={() => removeVendor(item.docId)} className="flex items-center justify-center px-2 py-1 rounded-lg font-semibold text-white bg-red-500 hover:bg-red-600 text-xs">Remove</button></td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </PartySection>

            <PartySection title="Chat" defaultOpen>
                <div className="space-y-4 h-64 overflow-y-auto hide-scrollbar border border-slate-200 p-4 rounded-lg">
                    {messages?.sort((a, b) => b.timestamp - a.timestamp).map(msg => {
                        const isMe = msg.authorId === myContactId;
                        const author = contacts.find(c => c.docId === msg.authorId);
                        return (
                            <div key={msg.docId} className={`p-3 rounded-lg max-w-[80%] ${isMe ? 'bg-blue-500 text-white ml-auto' : 'bg-slate-200 text-slate-800'}`}>
                                <div className="font-semibold text-xs mb-1">{isMe ? 'You' : author?.name || 'Unknown'}</div>
                                <p className="mt-1 text-sm">{msg.message}</p>
                                <div className="text-xs text-right text-slate-400 mt-1">{new Date(msg.timestamp).toLocaleString()}</div>
                            </div>
                        );
                    })}
                </div>
                <form className="flex items-center gap-2" onSubmit={postMessage}>
                    <input id="chatInput" type="text" placeholder="Type a message..." className="flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/>
                    <button type="submit" className="flex items-center justify-center px-4 py-2 rounded-lg font-semibold text-white bg-slate-800 hover:bg-slate-900 transition-colors shadow-md">Send</button>
                </form>
            </PartySection>
        </div>
    );
};

const AttendeeDetails = ({ party, items, messages, contacts, myContactId, onUpdateItems, onUpdateMessages, showMessage }) => {
    const statusBadge = s => {
        const colors = { 'picked': 'bg-green-100 text-green-600', 'ordered': 'bg-blue-100 text-blue-600', 'todo': 'bg-slate-100 text-slate-600' };
        return <span className={`inline-flex items-center gap-1 text-xs font-medium rounded-full px-2 py-0.5 ${colors[s]}`}>{s.toUpperCase()}</span>;
    };
    
    const postMessage = async (e) => {
        e.preventDefault();
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if (!text) return;

        const myContact = contacts.find(c => c.docId === myContactId);
        const newMessageObj = {
            docId: `msg-${Date.now()}`,
            message: text,
            authorId: myContactId,
            timestamp: Date.now()
        };
        onUpdateMessages([...messages, newMessageObj]);
        input.value = '';
        showMessage('Message posted!', 'success');
    };
    
    return (
        <div id="attendBlocks" className="space-y-6">
            <div className="bg-white rounded-xl shadow-md p-4 space-y-4">
                <h4 className="text-lg font-semibold text-slate-700">Attending Details</h4>
                <div><label className="block text-sm font-medium text-slate-600 mb-1">Gift I plan to bring</label><input value={party.attend?.giftPlan || ''} onChange={e => {
                    const updatedParties = myParties.map(p => p.docId === party.docId ? { ...p, attend: { ...p.attend, giftPlan: e.target.value } } : p);
                    setMyParties(updatedParties);
                }} className="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Gift ideaâ¦"/></div>
                <div><label className="block text-sm font-medium text-slate-600 mb-1">Notes (what to bring / reminders)</label><textarea value={party.attend?.notes || ''} onChange={e => {
                    const updatedParties = myParties.map(p => p.docId === party.docId ? { ...p, attend: { ...p.attend, notes: e.target.value } } : p);
                    setMyParties(updatedParties);
                }} className="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Snacks? Cooler? Ride?"></textarea></div>
            </div>
            <div className="bg-white rounded-xl shadow-md p-4 space-y-4">
                <h4 className="text-lg font-semibold text-slate-700">Your Assigned Tasks</h4>
                <div className="space-y-2">
                    {items?.filter(item => item.assignedTo === myContactId).length > 0 ? (
                        items.filter(item => item.assignedTo === myContactId).map(item => (
                            <div key={item.docId} className="flex items-center gap-2 p-2 bg-slate-100 rounded-lg">
                                <input type="checkbox" checked={item.status === 'picked'} onChange={e => onUpdateItems(items.map(it => it.docId === item.docId ? { ...it, status: e.target.checked ? 'picked' : 'todo' } : it))} className="w-4 h-4 rounded text-blue-600 focus:ring-blue-500 border-slate-300"/>
                                <span className={`flex-1 text-sm ${item.status === 'picked' ? 'line-through text-slate-400' : ''}`}>{item.name} (Qty: {item.qty})</span>
                            </div>
                        ))
                    ) : (
                        <div className="text-sm text-slate-500">No tasks assigned to you.</div>
                    )}
                </div>
            </div>
            <PartySection title="Chat" defaultOpen>
                <div className="space-y-4 h-64 overflow-y-auto hide-scrollbar border border-slate-200 p-4 rounded-lg">
                    {messages?.sort((a, b) => b.timestamp - a.timestamp).map(msg => {
                        const isMe = msg.authorId === myContactId;
                        const author = contacts.find(c => c.docId === msg.authorId);
                        return (
                            <div key={msg.docId} className={`p-3 rounded-lg max-w-[80%] ${isMe ? 'bg-blue-500 text-white ml-auto' : 'bg-slate-200 text-slate-800'}`}>
                                <div className="font-semibold text-xs mb-1">{isMe ? 'You' : author?.name || 'Unknown'}</div>
                                <p className="mt-1 text-sm">{msg.message}</p>
                                <div className="text-xs text-right text-slate-400 mt-1">{new Date(msg.timestamp).toLocaleString()}</div>
                            </div>
                        );
                    })}
                </div>
                <form className="flex items-center gap-2" onSubmit={postMessage}>
                    <input id="chatInput" type="text" placeholder="Type a message..." className="flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/>
                    <button type="submit" className="flex items-center justify-center px-4 py-2 rounded-lg font-semibold text-white bg-slate-800 hover:bg-slate-900 transition-colors shadow-md">Send</button>
                </form>
            </PartySection>
        </div>
    );
};

export default App;
